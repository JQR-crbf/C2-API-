# 管理员审核功能测试指南

## 功能概述
管理员审核功能已成功实现，允许管理员对处于"管理员审核"状态的任务进行通过或拒绝操作。

## 测试步骤

### 1. 确认管理员身份
- 使用管理员账户登录系统（用户名：jinqianru，密码：123456）
- 确认用户角色为 admin

### 2. 访问任务详情页面
- 打开浏览器访问：http://localhost:3000/tasks/4
- 点击"进度"标签页
- 查看任务工作流程

### 3. 测试审核功能

#### 3.1 审核通过测试
1. 在"管理员审核"步骤中，点击绿色的"通过"按钮
2. 系统应显示成功提示
3. 任务状态应更新为"已部署"
4. 工作流程应自动进入下一步

#### 3.2 审核拒绝测试
1. 在"管理员审核"步骤中，点击红色的"拒绝"按钮
2. 系统弹出拒绝理由对话框
3. 输入拒绝理由（必填），例如："代码有bug，需要重新生成"
4. 点击"确认拒绝"按钮
5. 系统应显示成功提示
6. 任务状态应回退到"代码生成中"

### 4. 验证数据持久化

#### 4.1 检查任务状态
```bash
# 在backend目录下运行
python -c "from database import get_db; from models import Task; db = next(get_db()); task = db.query(Task).filter(Task.id == 4).first(); print(f'Task {task.id}: status={task.status.value}, admin_comment={task.admin_comment}')"
```

#### 4.2 检查任务日志
```bash
# 查看任务日志记录
python -c "from database import get_db; from models import TaskLog; db = next(get_db()); logs = db.query(TaskLog).filter(TaskLog.task_id == 4).order_by(TaskLog.created_at.desc()).limit(3).all(); [print(f'{log.created_at}: {log.message}') for log in logs]"
```

#### 4.3 检查通知记录
```bash
# 查看相关通知
python -c "from database import get_db; from models import Notification; db = next(get_db()); notifications = db.query(Notification).filter(Notification.task_id == 4).order_by(Notification.created_at.desc()).limit(2).all(); [print(f'{n.title}: {n.content}') for n in notifications]"
```

### 5. 刷新页面测试
1. 执行审核操作后，刷新浏览器页面
2. 确认任务状态和审核记录仍然保持
3. 验证数据没有丢失

## 功能特点

### ✅ 已实现的功能
- **权限控制**：只有管理员用户才能看到审核按钮
- **状态验证**：只有处于"under_review"状态的任务才能进行审核
- **操作反馈**：通过和拒绝操作都有相应的toast提示
- **数据持久化**：审核结果、状态变更、日志记录都会保存到数据库
- **流程控制**：通过后进入部署完成状态，拒绝后回到代码生成状态
- **通知系统**：审核结果会自动发送通知给任务创建者
- **必填验证**：拒绝操作必须填写拒绝理由

### 🔧 技术实现
- **后端API**：`POST /api/admin/tasks/{task_id}/review`
- **参数传递**：使用URL查询参数传递action和comment
- **状态管理**：使用React hooks管理加载状态和对话框状态
- **错误处理**：完整的错误捕获和用户友好的错误提示

## 故障排除

### 如果遇到422错误
1. 检查任务状态是否为"under_review"
2. 确认用户是否具有管理员权限
3. 拒绝操作时确保填写了拒绝理由

### 重置任务状态（用于测试）
```bash
# 将任务4重新设置为审核状态
python -c "from database import get_db; from models import Task, TaskStatus; db = next(get_db()); task = db.query(Task).filter(Task.id == 4).first(); task.status = TaskStatus.UNDER_REVIEW; db.commit(); print('Task status reset to under_review')"
```

## 注意事项
1. 审核操作是不可逆的，请谨慎操作
2. 拒绝理由会发送给任务创建者，请填写有意义的内容
3. 审核记录会永久保存在数据库中
4. 页面刷新不会丢失审核状态和记录