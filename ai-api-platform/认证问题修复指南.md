# 前端认证问题修复指南

## 问题描述
当前 `jinqianru` 用户在前端应用中遇到认证问题，可能表现为：
- 登录后无法访问受保护的页面
- API 调用返回 401 未授权错误
- Token 过期或无效
- 页面显示认证失败

## 解决方案

### 方案一：浏览器控制台快速修复（推荐）

1. **打开浏览器开发者工具**
   - 在前端应用页面按 `F12` 或右键选择「检查」
   - 切换到「Console」（控制台）标签页

2. **运行快速修复脚本**
   - 复制 `console_fix.js` 文件中的所有代码
   - 粘贴到控制台中并按回车执行
   - 脚本会自动：
     - 检查当前 token 状态
     - 清除过期的认证信息
     - 使用正确的凭据重新登录
     - 测试 API 连接

3. **查看执行结果**
   - 如果看到 "✅ 修复完成，请刷新页面"，说明修复成功
   - 刷新页面后应该可以正常使用

### 方案二：完整诊断和修复

1. **运行完整诊断脚本**
   - 复制 `fix_frontend_auth.js` 文件中的所有代码
   - 粘贴到浏览器控制台执行

2. **查看诊断结果**
   - 脚本会详细检查认证状态、token 有效性、API 连接等
   - 根据诊断结果自动执行相应的修复操作

3. **使用可用命令**
   ```javascript
   // 检查认证状态
   authFixer.checkStatus()
   
   // 测试 API 连接
   authFixer.testAPI()
   
   // 清除认证信息
   authFixer.clearAuth()
   
   // 手动登录（如果默认密码不正确）
   authFixer.manualLogin('jinqianru', '正确的密码')
   
   // 快速修复
   authFixer.quickFix()
   
   // 刷新页面
   authFixer.refresh()
   ```

### 方案三：手动修复步骤

如果自动脚本无法解决问题，可以手动执行以下步骤：

1. **清除本地存储**
   ```javascript
   localStorage.removeItem('access_token');
   localStorage.removeItem('user_info');
   ```

2. **重新登录**
   ```javascript
   fetch('http://localhost:8000/api/auth/login', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       username: 'jinqianru',
       password: '正确的密码'
     })
   })
   .then(response => response.json())
   .then(data => {
     localStorage.setItem('access_token', data.access_token);
     localStorage.setItem('user_info', JSON.stringify(data.user_info));
     console.log('登录成功');
   });
   ```

3. **刷新页面**
   ```javascript
   location.reload();
   ```

## 常见问题解决

### Q: 脚本提示密码错误怎么办？
A: 修改脚本中的密码字段，或使用 `authFixer.manualLogin('jinqianru', '正确的密码')` 命令。

### Q: API 连接失败怎么办？
A: 确认后端服务正在运行（http://localhost:8000），检查网络连接。

### Q: 修复后仍然有问题怎么办？
A: 
1. 完全关闭浏览器重新打开
2. 清除浏览器缓存和 Cookie
3. 检查后端日志是否有错误信息
4. 确认用户账户在数据库中存在且状态正常

## 预防措施

1. **定期检查 Token 有效期**
   - Token 默认有效期为 24 小时
   - 可以在控制台运行 `authFixer.checkStatus()` 查看状态

2. **正确的登出流程**
   - 使用应用的登出功能而不是直接关闭浏览器
   - 确保登出时清除了本地存储的认证信息

3. **避免多标签页冲突**
   - 避免在多个标签页同时登录不同账户
   - 如果需要切换账户，先在当前标签页登出

## 技术说明

### 认证流程
1. 用户提交用户名和密码
2. 后端验证凭据并生成 JWT Token
3. 前端将 Token 存储在 localStorage
4. 后续 API 请求在 Authorization 头中携带 Token
5. 后端验证 Token 有效性

### Token 结构
- Header: 算法信息
- Payload: 用户信息（user_id, username, role, exp 等）
- Signature: 签名验证

### 存储位置
- `localStorage.access_token`: JWT Token
- `localStorage.user_info`: 用户基本信息

---

**注意**: 如果问题持续存在，请检查后端日志或联系技术支持。